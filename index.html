<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Tareas con L√≠nea de Tiempo v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8; /* slate-100 */
            color: #334155; /* slate-700 */
        }
        .container-app {
            max-width: 1280px; /* Un poco m√°s ancho */
            margin: 0 auto; 
        }
        .toast-container { 
            position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1050; 
            display: flex; flex-direction: column; gap: 0.75rem; 
        }
        .toast { 
            display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
            min-width: 320px; opacity: 0; transform: translateX(100%); 
            animation: slideInRight 0.5s forwards, fadeOut 0.5s 4.5s forwards; 
            border-left-width: 4px;
        }
        .toast-icon { margin-right: 0.75rem; font-size: 1.5rem; }
        .toast-success { background-color: #dcfce7; color: #166534; border-left-color: #22c55e; } /* green */
        .toast-error { background-color: #fee2e2; color: #991b1b; border-left-color: #ef4444; } /* red */
        .toast-info { background-color: #e0f2fe; color: #075985; border-left-color: #38bdf8; } /* sky */
        .toast-warning { background-color: #fef3c7; color: #92400e; border-left-color: #f59e0b; } /* amber */

        @keyframes slideInRight { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        #timeline-visualization {
            width: 100%;
            height: 550px; /* Un poco m√°s de altura */
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
            background-color: white;
        }
        .form-label {
            font-weight: 500;
            color: #475569; /* slate-600 */
        }
        .form-input {
            border-color: #cbd5e1; /* slate-300 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); 
            outline: none;
        }
        .btn {
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .btn:active {
            transform: translateY(0px);
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06);
        }
        .btn-primary { background-color: #4f46e5; } /* indigo-600 */
        .btn-primary:hover { background-color: #4338ca; } /* indigo-700 */
        .btn-secondary { background-color: #64748b; } /* slate-500 */
        .btn-secondary:hover { background-color: #475569; } /* slate-600 */
        .btn-danger { background-color: #dc2626; } /* red-600 */
        .btn-danger:hover { background-color: #b91c1c; } /* red-700 */
        
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
        }

        /* Estilos para items de la l√≠nea de tiempo */
        .vis-item.timeline-item-normal {
            background-color: #60a5fa; /* blue-400 */
            border-color: #2563eb; /* blue-600 */
            color: white;
        }
        .vis-item.timeline-item-sobretiempo-leve {
            background-color: #facc15; /* yellow-400 */
            border-color: #ca8a04; /* yellow-600 */
            color: #422006; /* yellow-900 */
        }
        .vis-item.timeline-item-sobretiempo-critico {
            background-color: #f87171; /* red-400 */
            border-color: #dc2626; /* red-600 */
            color: white;
        }
        .vis-item.timeline-item-temprano {
            background-color: #4ade80; /* green-400 */
            border-color: #16a34a; /* green-600 */
            color: #052e16; /* green-900 */
        }
        .vis-item .vis-item-content { /* Para que el texto dentro del item sea visible */
            padding: 4px 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vis-labelset .vis-label .vis-inner { /* Estilo para los nombres de los empleados (grupos) */
            padding: 8px 10px;
            font-weight: 500;
        }
    </style>
</head>
<body class="py-8 px-4">

    <div id="toast-container" class="toast-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="toast toast-{{ category }}" role="alert">
                        <span class="toast-icon">
                            {% if category == 'success' %}‚úÖ
                            {% elif category == 'error' %}‚ùå
                            {% elif category == 'warning' %}‚ö†Ô∏è
                            {% else %}‚ÑπÔ∏è
                            {% endif %}
                        </span>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container-app space-y-8">
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 pb-1">
                üóìÔ∏è Gesti√≥n de Tareas y Tiempos
            </h1>
            <p class="text-slate-500 text-lg">Registra tareas y visualiza el progreso en una l√≠nea de tiempo interactiva.</p>
        </header>

        <section id="registrar-tarea-section" class="section-card">
            <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Registrar Nueva Tarea
            </h2>
            <form id="form-registrar-tarea" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="empleado_nombre" class="block text-sm form-label mb-1">Nombre del Empleado <span class="text-red-500">*</span></label>
                        <input type="text" id="empleado_nombre" name="empleado_nombre" required class="w-full px-4 py-2.5 border rounded-md shadow-sm form-input" placeholder="Ej: Laura Vargas">
                    </div>
                    <div>
                        <label for="nombre_tarea" class="block text-sm form-label mb-1">Nombre de la Tarea <span class="text-red-500">*</span></label>
                        <input type="text" id="nombre_tarea" name="nombre_tarea" required class="w-full px-4 py-2.5 border rounded-md shadow-sm form-input" list="lista_nombres_tareas" placeholder="Ej: An√°lisis de Requisitos">
                        <datalist id="lista_nombres_tareas">
                            {% for nombre_tarea_existente in nombres_tareas_existentes %}
                                <option value="{{ nombre_tarea_existente }}">
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="tiempo_estipulado_base" class="block text-sm form-label mb-1">Tiempo Estipulado para este TIPO de Tarea (min)</label>
                        <input type="number" id="tiempo_estipulado_base" name="tiempo_estipulado_base" step="1" min="1" class="w-full px-4 py-2.5 border rounded-md shadow-sm form-input" placeholder="Ej: 90 (Est√°ndar para este tipo de tarea)">
                        <p class="mt-1 text-xs text-slate-500">Si la tarea es nueva o quiere actualizar su est√°ndar, ingr√©selo.</p>
                    </div>
                    <div>
                        <label for="tiempo_real_empleado" class="block text-sm form-label mb-1">Tiempo Real Empleado en ESTA Tarea (min) <span class="text-red-500">*</span></label>
                        <input type="number" id="tiempo_real_empleado" name="tiempo_real_empleado" step="1" min="1" required class="w-full px-4 py-2.5 border rounded-md shadow-sm form-input" placeholder="Ej: 85">
                    </div>
                </div>
                <button type="submit" class="w-full md:w-auto flex items-center justify-center btn btn-primary text-white font-semibold py-2.5 px-6 rounded-md shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Guardar Tarea
                </button>
            </form>
        </section>

        <section id="timeline-section" class="section-card">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <h2 class="text-2xl font-semibold text-slate-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-3.75h.008v.008H12v-.008ZM12 15h.008v.008H12v-.008ZM12 12h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75v-.008ZM9.75 12h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5v-.008ZM7.5 12h.008v.008H7.5v-.008ZM14.25 15h.008v.008h-.008v-.008ZM14.25 12h.008v.008h-.008v-.008ZM16.5 15h.008v.008h-.008v-.008ZM16.5 12h.008v.008h-.008v-.008Z" />
                    </svg>
                    L√≠nea de Tiempo de Tareas
                </h2>
                <button id="btn-refresh-timeline" class="btn btn-secondary text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">
                    Actualizar L√≠nea de Tiempo
                </button>
            </div>
            <div id="timeline-visualization">
                <p class="p-4 text-center text-slate-500">Cargando l√≠nea de tiempo...</p>
            </div>
        </section>
        
        <section id="actions-section" class="section-card">
             <h2 class="text-2xl font-semibold text-slate-700 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 mr-2 text-indigo-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.43.992a6.759 6.759 0 0 1 0 1.257c-.01.378.136.754.43.99l1.004.828c.414.34.515.93.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.6 6.6 0 0 1-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 0 1 0-1.257c.01-.378-.136-.754-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
                Acciones Adicionales
            </h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <a href="{{ url_for('descargar_informe_pdf_route') }}" id="btn-download-pdf" class="btn btn-primary text-white font-semibold py-2.5 px-5 rounded-md shadow-sm text-center">
                    Descargar Informe PDF
                </a>
                 <form action="{{ url_for('limpiar_todo_timeline_route') }}" method="POST" onsubmit="return confirm('¬°ATENCI√ìN! ¬øEst√° seguro que quiere eliminar TODOS los datos de tareas y empleados? Esta acci√≥n es IRREVERSIBLE.');" class="w-full sm:w-auto">
                    <button type="submit" class="w-full btn btn-danger text-white font-semibold py-2.5 px-5 rounded-md shadow-sm">
                        Limpiar Todos los Datos
                    </button>
                </form>
            </div>
        </section>

        <footer class="mt-10 text-center text-sm text-slate-500">
            <p>&copy; {{ now.year }} Gesti√≥n de Tareas. Creado con Flask y vis-timeline.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Manejo de Toasts
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach((toast, index) => {
                setTimeout(() => { 
                    toast.style.opacity = '1'; 
                    toast.style.transform = 'translateX(0)'; 
                }, 100 * (index + 1));
                toast.addEventListener('animationend', (e) => { 
                    if (e.animationName === 'fadeOut') toast.remove(); 
                });
            });

            const timelineContainer = document.getElementById('timeline-visualization');
            let timeline = null; 

            // Opciones para la l√≠nea de tiempo
            const timelineOptions = {
                locale: 'es', 
                editable: {
                    add: false, // No permitir a√±adir items directamente
                    updateTime: false, // No permitir mover items
                    updateGroup: false, // No permitir cambiar grupo de items
                    remove: false, // No permitir borrar items
                    overrideItems: false
                },
                groupOrder: 'content', 
                orientation: {axis: 'top', item: 'top'}, // Eje arriba, items se apilan desde arriba
                zoomMin: 1000 * 60 * 30, // Zoom m√≠nimo a 30 minutos
                zoomMax: 1000 * 60 * 60 * 24 * 30 * 3, // Zoom m√°ximo a ~3 meses
                stack: true, 
                stackSubgroups: true, // Apilar tambi√©n subgrupos si se usaran
                tooltip: {
                    followMouse: true,
                    overflowMethod: 'flip',
                    delay: 300 // Peque√±o delay para el tooltip
                },
                maxHeight: '500px', // Limitar altura
                autoResize: true,
                // Mover el eje de tiempo visible al inicio del d√≠a actual o al primer item
                // start: new Date(new Date().setHours(0,0,0,0)), 
                // end: new Date(new Date().setHours(23,59,59,999)),
                dataAttributes: ['all'], // Para poder usar atributos personalizados en items
                snap: function (date, scale, step) { // Ajustar al inicio de la hora
                    var hour = 60 * 60 * 1000;
                    return Math.round(date / hour) * hour;
                },
                margin: {
                    item : {
                      horizontal : 5, // margen horizontal entre items
                      vertical: 5    // margen vertical entre items
                    },
                    axis : 20 // margen entre el eje y los items
                }
            };

            async function fetchAndRenderTimeline() {
                const loadingMessage = '<p class="p-4 text-center text-slate-500">Actualizando datos de la l√≠nea de tiempo...</p>';
                if (timelineContainer) timelineContainer.innerHTML = loadingMessage;
                
                try {
                    const response = await fetch("{{ url_for('timeline_data') }}"); // Usar url_for para la ruta
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Error HTTP ${response.status}: ${errorText || response.statusText}`);
                    }
                    const data = await response.json();
                    
                    const items = new vis.DataSet(data.items);
                    const groups = new vis.DataSet(data.groups);

                    if (timelineContainer) timelineContainer.innerHTML = ''; // Limpiar mensaje de carga antes de renderizar

                    if (timeline) {
                        timeline.setItems(items);
                        timeline.setGroups(groups);
                    } else {
                        timeline = new vis.Timeline(timelineContainer, items, groups, timelineOptions);
                    }
                    
                    if (data.items.length > 0) {
                        timeline.fit(); // Ajustar zoom para ver todos los items
                        // Opcionalmente, enfocar en el √∫ltimo item a√±adido o en el d√≠a actual
                        // const lastItem = data.items.sort((a,b) => new Date(b.start) - new Date(a.start))[0];
                        // if(lastItem) timeline.focus(lastItem.id);
                    } else {
                         if (timelineContainer) timelineContainer.innerHTML = '<p class="p-4 text-center text-slate-500">No hay tareas registradas para mostrar.</p>';
                    }

                } catch (error) {
                    console.error('Error al cargar datos para la l√≠nea de tiempo:', error);
                    if (timelineContainer) timelineContainer.innerHTML = `<p class="p-4 text-center text-red-500">Error al cargar datos: ${error.message}. Intente recargar la p√°gina o presione "Actualizar L√≠nea de Tiempo".</p>`;
                }
            }

            fetchAndRenderTimeline();

            const formRegistrar = document.getElementById('form-registrar-tarea');
            if (formRegistrar) {
                formRegistrar.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const formData = new FormData(this);
                    
                    try {
                        const response = await fetch("{{ url_for('registrar_tarea_route') }}", {
                            method: 'POST',
                            body: formData
                        });
                        // Flask redirige, el navegador lo sigue. La p√°gina se recarga y muestra el flash.
                        // La recarga tambi√©n hace que fetchAndRenderTimeline se ejecute de nuevo.
                        if (response.ok && response.redirected) {
                             window.location.href = response.url; 
                        } else if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: `Error del servidor: ${response.statusText}` }));
                            showToast(errorData.error , 'error');
                        }
                    } catch (error) {
                        console.error('Error en el env√≠o del formulario:', error);
                        showToast(`Error de red: ${error.message}`, 'error');
                    }
                });
            }
            
            const btnRefresh = document.getElementById('btn-refresh-timeline');
            if(btnRefresh) {
                btnRefresh.addEventListener('click', fetchAndRenderTimeline);
            }

            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.setAttribute('role', 'alert');
                const iconSpan = document.createElement('span');
                iconSpan.className = 'toast-icon';
                if (type === 'success') iconSpan.textContent = '‚úÖ';
                else if (type === 'error') iconSpan.textContent = '‚ùå';
                else if (type === 'warning') iconSpan.textContent = '‚ö†Ô∏è';
                else iconSpan.textContent = '‚ÑπÔ∏è';
                const messageSpan = document.createElement('span');
                messageSpan.textContent = message;
                toast.appendChild(iconSpan);
                toast.appendChild(messageSpan);
                toastContainer.appendChild(toast);
                setTimeout(() => { 
                    toast.style.opacity = '1'; 
                    toast.style.transform = 'translateX(0)'; 
                }, 10);
                toast.addEventListener('animationend', (e) => { 
                    if (e.animationName === 'fadeOut') toast.remove(); 
                });
            }
        });
    </script>
</body>
</html>